#!/bin/bash

# run this script in your test dir (where your index.js file is) to instrument the index.js file using Wasabi 


if [[ -z "$1" || "$1" == "--help" || "$1" == "-h" ]]; then 
	echo "Usage: instrument-test.sh [PATH]"
	echo "PATH is the path of the wasm file to be instrumented."  
	exit 1
fi

# extract name of wasm file and directory that the wasm file resides in 
WASM_FILE=${1##*/}
WASM_DIR=${1%/*}


if [[ -z "$WASM_FILE" ]]; then 
	echo "Usage: instrument-test.sh [PATH]"
	echo "PATH is the path of the wasm file to be instrumented."  
	exit 1
fi


CURR_PATH=`pwd`

cd $WASM_DIR


# sanity check to make sure that the wasm file actually exists in this directory 
if [[ ! -f $WASM_FILE ]]; then
	echo "Invalid Path passed as input"
	exit 1 
fi 

# instrument the wasm file using wasabi 
# generate hooks for all calls, beginning of functions and store instructions 
wasabi --node --hooks=begin,call,store $WASM_FILE


# create new directory to save the original wasm file 
mkdir org-wasm 
mv "$WASM_FILE" "org-wasm/"


# copy all files in the out folder generated by wasabi into the dir one level above  
cp -v ./out/* . > /dev/null


# save the full path of the wasabi file - we want to use it in our instrumented js file 
wasabi_file=`find . -maxdepth 1 -type f -name "*.wasabi.js"`
wasabi_file=`realpath --relative-to=$CURR_PATH $wasabi_file`

# cd to the test directory again 
cd $CURR_PATH


# create instrumented file 
echo "global.Wasabi = require(\"./$wasabi_file\");
let analysis = require(\"./../../analysis.js\");
" > instrumented-index.js

echo "let filename = \`\${__filename}\`" >> instrumented-index.js
echo "filename = filename.split(\"/\").slice(-3)" >> instrumented-index.js
echo "global.lib_name = filename[0]" >> instrumented-index.js
echo "global.test_name = filename[1]" >> instrumented-index.js
echo "" >> instrumented-index.js


cat index.js >> instrumented-index.js

echo "require('./../../collect-data.js')" >> instrumented-index.js

echo "Instrumentation complete."
echo "Check the instrumented-index.js file to make sure the require of collect.js is in the right place."


